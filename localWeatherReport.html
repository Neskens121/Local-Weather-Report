<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.9/css/weather-icons.min.css" />
	<script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
	<script src="http://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyDM-X-fWiW6i_0xkEOdyJY_kNEdLZTYiDc" type="text/javascript"></script>
	<script>
		window.onload = initialize();
		var locationInfo = {
			city: '',
			countrycode: '',
			latitude: '', 
			longitude: ''
		}

		var geocoder;

		function initialize() {
			geocoder = new google.maps.Geocoder();
		}

		function supportsGeolocation() {
			return 'geolocation' in navigator;
		}

		function getGeolocationInfo(){
			supportsGeolocation() && navigator.geolocation.getCurrentPosition(setLocationOfCity, geoErrorCallback)
		}

		function setLocationOfCity(location){
			locationInfo.longitude = location.coords.latitude;
			locationInfo.longitude = location.coords.longitude;
			reverseGeolocation(location.coords.latitude, location.coords.longitude)
		}

		function geoErrorCallback(err){

		}

		function reverseGeolocation(lat, lng) {
			var latlng = new google.maps.LatLng(lat, lng);
			geocoder.geocode({'latLng': latlng}, function(results, status) {
				var city;
				if (status == google.maps.GeocoderStatus.OK) {
					// If there is some result	
					if (results[1]) {
						console.log(results[0].formatted_address)
						// For each instance of result check all its address_components
						for (var i=0; i<results[0].address_components.length; i++) {
							// For every address_component check its property 'types' which is array
							for (var b=0;b<results[0].address_components[i].types.length;b++) {
								// if any member of types array is equal to "administrative_area_level_2" asign that address_component
								// there are different types that might hold a city, admin_area_lvl_2 usually is for Serbia
								if (results[0].address_components[i].types[b] == "administrative_area_level_2") {
									city = results[0].address_components[i];
									alert(city.short_name)
									//document.getElementById('city2').value = city.short_name;
									return city.short_name;
								}
							}
						}
					} else {
						alert("No results found");
					}
				} else {
					alert("Geocoder failed due to: " + status);
				}
			});
		}



		// using maxmind API for providing basic user information, city countrycode etc, through one of API methods geoip2.city
		var onSuccess = function(location){
			console.log(location)
			var longitude = location['location']['longitude'];
			var latitude = location['location']['latitude'];
			//var city = location['city']['names']['en'];
			//var country = location['registered_country']['iso_code'];

			getWeatherInfo(longitude, latitude).then(function(result){
				console.log(result)
				var weather = result['list'][1]['weather'][0];
				document.getElementById('weatherIcon').src = 'http://openweathermap.org/img/w/'+ weather['icon'] +'.png';
			})
			
		}
		var onError = function(error){

		};

		//actually you get Promise of WeatherInfo
		function getWeatherInfo(longitude, latitude){
						//http://api.openweathermap.org/data/2.5/forecast?lat=44.8186&lon=20.4681&APPID=1606cd61e974fa5479b45020b25cbd13&cnt=4
			return fetch('http://api.openweathermap.org/data/2.5/forecast?lat=' + latitude + '&lon=' + longitude + '&APPID=1606cd61e974fa5479b45020b25cbd13&cnt=4').then(function(response) { 
				return response.json();
			})
		}

		geoip2.city(onSuccess, onError);
		getGeolocationInfo()
	</script>


	<script type="text/javascript">
	// using Google API for adding autocomplete functionality with generating information, longitude and latitude etc, about city that is being searched
	// solution was found as answer on following post http://stackoverflow.com/questions/13478646/google-map-api-get-latitude-and-longitude-from-autocomplete-without-map
	function initialize() {
		var input = document.getElementById('searchTextField');
		var autocomplete = new google.maps.places.Autocomplete(input);
		google.maps.event.addListener(autocomplete, 'place_changed', function () {
			var place = autocomplete.getPlace();
			document.getElementById('city2').value = place.name;
			document.getElementById('cityLat').value = place.geometry.location.lat();
			document.getElementById('cityLng').value = place.geometry.location.lng();
		});
	}
	google.maps.event.addDomListener(window, 'load', initialize); 
</script>
</head>
<body>
	<div>sabnsa</div>
	<img id ="weatherIcon" src="">
	<div><i class="wi wi-day-snow-thunderstorm"></i></div>
	<input id="searchTextField" type="text" size="50" placeholder="Enter a location" autocomplete="on" runat="server" />  
	<input type="hidden" id="city2" name="city2" />
	<input type="hidden" id="cityLat" name="cityLat" />
	<input type="hidden" id="cityLng" name="cityLng" />  
</body>
</html>